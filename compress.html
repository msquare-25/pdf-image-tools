<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="description" content="Free, fast, and private PDF & Image tools — everything runs in your browser (no uploads).">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compress PDF — Client-side</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="stylesheet" href="/style.css" />
  <script defer src="/site.js"></script>
  <script defer src="/assets/seo.js"></script>
  <meta name="color-scheme" content="light dark" />
</head>
<body>

<header class="site-header">
  <div class="container bar">
    <div class="brand">
      <span class="logo"></span>
      <span>PDF &amp; Image Tools</span>
    </div>

    <div class="container tool-tabs-wrap">
      <button class="tool-scroll tool-left" aria-label="Scroll tools left" title="Scroll left">‹</button>
      <nav class="tool-tabs" role="navigation" aria-label="Tools">
        <a href="/merge">Merge PDF</a>
        <a href="/delete-pages">Delete pages</a>
        <a href="/rotate-pages">Rotate PDF</a>
        <a href="/reorder-pages">Reorder PDF</a>
        <a href="/crop">Crop PDF</a>
        <a href="/compress" class="active">Compress PDF</a>
        <a href="/pdf-to-images">PDF → Images</a>
        <a href="/image-to-pdf">Image → PDF</a>
        <a href="/jpg-to-png">JPG → PNG</a>
        <a href="/png-to-jpg">PNG → JPG</a>
      </nav>
      <button class="tool-scroll tool-right" aria-label="Scroll tools right" title="Scroll right">›</button>
    </div>
  </div>
</header>

<main>
  <div class="wrap"><!-- SAME outer as PDF→Images -->

    <!-- ===== Controls panel (3 boxes inside one rounded panel) ===== -->
    <aside class="panel">
      <div class="grid-3">
        <!-- LEFT: Upload / Drop -->
        <section class="panel card box upload-box theme-center" id="dropzone" aria-label="Upload">
          <h2 class="title">Upload</h2>
          <p class="muted">Drag &amp; drop PDF here</p>
          <label for="file" class="btn gradient big">Browse PDF</label>
          <input id="file" type="file" accept="application/pdf" hidden />
          <div class="pill mt-2" id="meta">No file</div>
          <button class="btn subtle mt-1" id="clearBtn" disabled>Clear</button>
          <div class="small mt-2">Everything runs in your browser (no uploads).</div>
        </section>

        <!-- MIDDLE: Settings -->
        <section class="panel card box settings-box theme-center" aria-label="Setting">
          <h2 class="title">Setting</h2>
          <label class="block mt-1">Preset
            <select id="preset" class="select-lg">
              <option value="balanced">Balanced (good quality)</option>
              <option value="small">Smaller (more compression)</option>
              <option value="tiny">Tiny (max compression)</option>
            </select>
          </label>

          <details class="mt-2">
            <summary>Advanced</summary>
            <div class="grid-2 mt-2">
              <label>DPI
                <input id="dpi" type="number" min="56" max="144" step="1" value="110" />
              </label>
              <label>JPEG Quality
                <input id="quality" type="number" min="0.4" max="0.9" step="0.01" value="0.70" />
              </label>
            </div>
            <label class="row mt-1"><input id="preferOriginal" type="checkbox" checked />
              <span class="small">Keep original if compressed is larger</span></label>
          </details>

          <div class="small mt-2">Presets auto-set DPI &amp; JPEG quality. You can fine-tune above if needed.</div>
        </section>

        <!-- RIGHT: Run / Progress / Download -->
        <section class="panel card box action-box theme-center" aria-label="Download">
          <h2 class="title">Download</h2>
          <progress id="prog" max="100" value="0" class="w-100"></progress>
          <div id="status" class="small">Idle…</div>
          <div class="row center mt-2" style="gap:10px">
          <button id="compressBtn" class="btn" disabled>Download New PDF</button>
          </div>      
        </section>
      </div>
    </aside>

    <!-- ===== Title + How it works (mirror PDF→Images) ===== -->
    <main class="panel">
      <h1 class="page-title">Compress PDF</h1>
      <p class="sub">Reduce file size while keeping quality — everything runs in your browser.</p>

      <section class="card mt-3">
        <h2 class="title">How it works</h2>
        <ul class="sub">
          <li>Each page is rendered to an image via <strong>PDF.js</strong>, then rebuilt as a compact PDF with <strong>pdf-lib</strong>.</li>
          <li>Great for scans/photos. Text-only PDFs may not shrink much.</li>
          <li>If the compressed file is larger and “Keep original” is ON, we serve the original.</li>
        </ul>
        <p class="sub mt-1">Privacy: No uploads. Everything stays on your device.</p>
      </section>
    </main>

  </div>
  
  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <!-- page script -->
  <script>
    const $ = (s) => document.querySelector(s);
    const fileInput = $('#file');
    const compressBtn = $('#compressBtn');
    const clearBtn = $('#clearBtn');
    const meta = $('#meta');
    const presetEl = $('#preset');
    const dpiEl = $('#dpi');
    const qEl = $('#quality');
    const prog = $('#prog');
    const statusEl = $('#status');
    const preferOriginalEl = $('#preferOriginal');
    const dropzone = $('#dropzone');
   
    let pdfBytesOriginal = null, pdfDocJS = null, pageCount = 0, fileName = 'input.pdf';

    function presetValues(k){
      if(k==='balanced') return { dpi:110, quality:0.70 };
      if(k==='small')    return { dpi:96,  quality:0.65 };
      if(k==='tiny')     return { dpi:72,  quality:0.58 };
      return { dpi:110, quality:0.70 };
    }
    function applyPreset(){
      const {dpi, quality} = presetValues(presetEl.value);
      dpiEl.value = dpi;
      qEl.value   = quality;
    }
    presetEl.addEventListener('change', applyPreset);
    applyPreset();

    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if(!f) return;
      await loadFile(f);
    });

    clearBtn.addEventListener('click', () => {
      pdfBytesOriginal = null; pdfDocJS = null; pageCount = 0;
      fileInput.value = '';
      meta.textContent = 'No file';
      statusEl.textContent = 'Idle…';
      compressBtn.disabled = true;
      compressBtn.classList.remove('primary-blue');   // reset CTA color
      clearBtn.disabled = true;
      prog.value = 0; prog.max = 100;
    });

    ['dragenter','dragover'].forEach(ev =>
      dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.classList.add('dropping'); })
    );
    ['dragleave','drop'].forEach(ev =>
      dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.classList.remove('dropping'); })
    );
    dropzone.addEventListener('drop', async (e) => {
      const f = e.dataTransfer?.files?.[0];
      if(!f) return;
      if(!/application\/pdf/.test(f.type) && !/\.pdf$/i.test(f.name)) {
        alert('Please drop a PDF file.');
        return;
      }
      await loadFile(f);
    });

    async function loadFile(f){
      fileName = f.name || 'input.pdf';
      pdfBytesOriginal = new Uint8Array(await f.arrayBuffer());
      pdfDocJS = await pdfjsLib.getDocument({ data: pdfBytesOriginal.slice() }).promise;
      pageCount = pdfDocJS.numPages;
      meta.textContent = `${fileName} • ${pageCount} pages • ${(f.size/1024/1024).toFixed(2)} MB`;

      compressBtn.disabled = false;
      compressBtn.classList.add('primary-blue');      // CTA turns blue
      clearBtn.disabled = false;
      statusEl.textContent = 'Ready to compress.';
    }

      compressBtn.addEventListener('click', () => runCompress().catch(err => {
      alert('Compression failed: ' + (err?.message || err));
      statusEl.textContent = 'Error.';
      compressBtn.disabled = false;
    }));

    async function runCompress(){
      if(!pdfDocJS) return;
      const dpi = clamp(parseInt(dpiEl.value || 110, 10), 56, 200);
      const quality = clamp(parseFloat(qEl.value || 0.7), 0.4, 0.95);

      compressBtn.disabled = true;
      statusEl.textContent = `Rendering pages… (DPI ${dpi}, Q ${quality.toFixed(2)})`;

      prog.value = 0; prog.max = pageCount;

      const out = await PDFLib.PDFDocument.create();

      for(let i=1;i<=pageCount;i++){
        statusEl.textContent = `Rendering page ${i}/${pageCount}…`;
        const page = await pdfDocJS.getPage(i);
        const viewport = page.getViewport({ scale: dpi/72 });

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        canvas.width  = Math.max(1, Math.floor(viewport.width));
        canvas.height = Math.max(1, Math.floor(viewport.height));

        await page.render({ canvasContext: ctx, viewport }).promise;

        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        const jpgBytes = dataURLToUint8Array(dataUrl);
        const jpgImage = await out.embedJpg(jpgBytes);

        const pdfPage = out.addPage([canvas.width, canvas.height]);
        pdfPage.drawImage(jpgImage, { x:0, y:0, width:canvas.width, height:canvas.height });

        page.cleanup();
        prog.value = i;
        await new Promise(r => setTimeout(r, 0));
      }

      statusEl.textContent = 'Saving PDF…';
      const outBytes = await out.save({ updateFieldAppearances:false });

      const useOriginal = preferOriginalEl.checked && pdfBytesOriginal && (outBytes.length >= pdfBytesOriginal.length);
      if(useOriginal) alert('Already optimized. Keeping the original.');

      const finalBytes = useOriginal ? pdfBytesOriginal : outBytes;
      const blob = new Blob([finalBytes], { type:'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'compressed.pdf'; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1500);

      statusEl.textContent = 'Done.';
      compressBtn.disabled = false;
    }

    function dataURLToUint8Array(dataURL){
      const binaryString = atob(dataURL.split(',')[1]);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for(let i=0;i<len;i++) bytes[i] = binaryString.charCodeAt(i);
      return bytes;
    }
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  </script>
</main>
</body>
</html>
