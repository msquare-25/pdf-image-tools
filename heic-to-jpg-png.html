<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: blob:; worker-src 'self' blob:;">
  
  <title>HEIC ‚Üí JPG/PNG ‚Äî Fixed</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="stylesheet" href="/style.css" />
  <script defer src="/site.js"></script>
  <script defer src="/assets/seo.js"></script>

  <style>
    /* Error Box Style */
    #debug-error {
      display: none;
      background: #ffe6e6;
      border: 2px solid #ff0000;
      color: #cc0000;
      padding: 15px;
      margin: 20px;
      border-radius: 8px;
      font-family: monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body class="tool-page">

<div id="debug-error"></div>

<header class="site-header">
  <div class="container bar">
    <div class="brand">
      <a href="/" class="home-link"><span class="logo"></span><span>PDFimageLab</span></a>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <aside class="panel">
      <div class="grid-3">
        <section class="panel card box upload-box theme-center" id="dropzone">
          <h2 class="title">Upload</h2>
          <label for="file" class="btn gradient big">Browse HEIC</label>
          <input id="file" type="file" accept=".heic,.heif,image/heic,image/heif" multiple hidden />
          <div class="pill mt-2" id="meta">No file</div>
          <button class="btn subtle mt-1" id="clearBtn" disabled>Clear</button>
        </section>

        <section class="panel card box settings-box theme-center">
          <h2 class="title">Setting</h2>
          <label class="block mt-1">Output format
            <div class="select-wrap mt-1">
              <select id="format" class="select-lg">
                <option value="jpg">JPG</option>
                <option value="png">PNG</option>
              </select>
            </div>
          </label>
          <div id="jpgSettings" class="mt-2">
            <label class="block">Quality <input id="quality" type="range" min="0.5" max="0.99" step="0.01" value="0.92" /></label>
          </div>
        </section>

        <section class="panel card box action-box theme-center">
          <h2 class="title">Download</h2>
          <progress id="prog" max="100" value="0" class="w-100"></progress>
          <div id="status" class="small">Idle‚Ä¶</div>
          <div class="row center mt-2" style="gap:10px">
            <button id="convertBtn" class="btn" disabled>Convert &amp; Download</button>
          </div>
        </section>
      </div>
    </aside>

    <section class="tool-copy">
      <h1>HEIC to JPG/PNG Fixed</h1>
      <p>Local processing without upload.</p>
    </section>
  </div>

  <script src="heic2any.min.js"></script>
  
  <script>
    // --- ERROR CATCHER SYSTEM ---
    window.onerror = function(msg, url, line) {
        const errBox = document.getElementById('debug-error');
        errBox.style.display = 'block';
        errBox.innerHTML += `üõë <b>Error:</b> ${msg}\nüìÇ <b>File:</b> ${url}\nüî¢ <b>Line:</b> ${line}\n--------------------------\n`;
        return false;
    };

    // --- MAIN LOGIC ---
    (function () {
        // Step 1: Check Library
        if (typeof heic2any === 'undefined') {
            document.getElementById('debug-error').style.display = 'block';
            document.getElementById('debug-error').innerHTML += "‚ö†Ô∏è <b>CRITICAL ERROR:</b> 'heic2any.min.js' load nathi thai!\nCheck karo ke aa file HTML file ni sathe 'Same Folder' ma chhe ke nahi.\n";
            return;
        }

        // Step 2: Disable Worker (Security Fix)
        try {
            delete window.Worker;
            window.Worker = null;
            console.log("Worker disabled to bypass CSP.");
        } catch(e) { console.error(e); }

        const $ = (s) => document.querySelector(s);
        const fileInput = $('#file');
        const convertBtn = $('#convertBtn');
        const statusEl = $('#status');
        const prog = $('#prog');
        const formatEl = $('#format');
        const qualityEl = $('#quality');
        
        let files = [];

        fileInput.addEventListener('change', (e) => {
            files = Array.from(e.target.files || []);
            $('#meta').textContent = `${files.length} selected`;
            convertBtn.disabled = !files.length;
            statusEl.textContent = "Ready.";
        });

        convertBtn.addEventListener('click', async () => {
            if (!files.length) return;
            
            convertBtn.disabled = true;
            statusEl.textContent = "Initializing...";
            
            const quality = parseFloat(qualityEl.value);
            const format = formatEl.value;
            const mime = format === 'png' ? 'image/png' : 'image/jpeg';

            let i = 0;
            for (const f of files) {
                try {
                    statusEl.textContent = `Converting ${f.name}... (Wait)`;
                    
                    // Conversion Call
                    const result = await heic2any({
                        blob: f,
                        toType: mime,
                        quality: quality
                    });

                    const finalBlob = Array.isArray(result) ? result[0] : result;
                    const url = URL.createObjectURL(finalBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = f.name.replace(/\.hei[cf]$/i, "") + "." + format;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                    
                    i++;
                    prog.value = (i / files.length) * 100;

                } catch (err) {
                    const errBox = document.getElementById('debug-error');
                    errBox.style.display = 'block';
                    errBox.innerHTML += `‚ùå <b>Conversion Failed for ${f.name}:</b> ${err.message}\n`;
                    console.error(err);
                }
            }
            
            statusEl.textContent = "Done!";
            convertBtn.disabled = false;
        });

    })();
  </script>

</main>
</body>
</html>
