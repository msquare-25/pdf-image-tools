<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap: content: blob:; style-src 'self' 'unsafe-inline'; script-src * 'self' 'unsafe-inline' 'unsafe-eval' blob: https://unpkg.com; worker-src * 'self' 'unsafe-inline' 'unsafe-eval' blob:;">
  
  <title>HEIC → JPG/PNG — PDF Image Lab</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="stylesheet" href="/style.css" />
  <script defer src="/site.js"></script>
  <script defer src="/assets/seo.js"></script>

  <style>
    /* Error Box Style */
    #debug-error {
      display: none;
      background: #ffe6e6;
      border: 2px solid #ff0000;
      color: #cc0000;
      padding: 15px;
      margin: 20px;
      border-radius: 8px;
      font-family: monospace;
      white-space: pre-wrap;
      font-weight: bold;
    }
  </style>
</head>
<body class="tool-page">

<div id="debug-error"></div>

<header class="site-header">
  <div class="container bar">
    <div class="brand">
      <a href="/" class="home-link"><span class="logo"></span><span>PDFimageLab</span></a>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <aside class="panel">
      <div class="grid-3">
        <section class="panel card box upload-box theme-center" id="dropzone">
          <h2 class="title">Upload</h2>
          <p class="muted">Drag &amp; drop HEIC images here</p>
          <label for="file" class="btn gradient big">Browse HEIC</label>
          <input id="file" type="file" accept=".heic,.heif,image/heic,image/heif" multiple hidden />
          <div class="pill mt-2" id="meta">No file</div>
          <button class="btn subtle mt-1" id="clearBtn" disabled>Clear</button>
        </section>

        <section class="panel card box settings-box theme-center">
          <h2 class="title">Setting</h2>
          <label class="block mt-1">Output format
            <div class="select-wrap mt-1">
              <select id="format" class="select-lg">
                <option value="jpg">JPG (Small)</option>
                <option value="png">PNG (Lossless)</option>
              </select>
            </div>
          </label>
          <div id="jpgSettings" class="mt-2">
            <label class="block">Quality <input id="quality" type="range" min="0.5" max="0.99" step="0.01" value="0.92" /></label>
            <div class="small" id="qLabel">Quality: 0.92</div>
          </div>
        </section>

        <section class="panel card box action-box theme-center">
          <h2 class="title">Download</h2>
          <progress id="prog" max="100" value="0" class="w-100"></progress>
          <div id="status" class="small">Idle…</div>
          <div class="row center mt-2" style="gap:10px">
            <button id="convertBtn" class="btn" disabled>Convert &amp; Download</button>
          </div>
        </section>
      </div>
    </aside>

    <section class="tool-copy">
      <h1>HEIC to JPG/PNG</h1>
      <p>Convert iPhone photos to JPG or PNG instantly.</p>
    </section>
  </div>

  <script>
    console.log("Applying Security Patch...");
    // Bypass CSP Worker restrictions
    try {
        window.Worker = undefined;
    } catch(e) { console.error(e); }
  </script>

  <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>
  
  <script>
    window.onerror = function(msg, url, line) {
        const errBox = document.getElementById('debug-error');
        errBox.style.display = 'block';
        errBox.textContent += `Error: ${msg}\nLine: ${line}\n`;
        return false;
    };

    (function () {
        // Library Check
        if (typeof heic2any === 'undefined') {
            document.getElementById('debug-error').style.display = 'block';
            document.getElementById('debug-error').innerHTML = "⚠️ ERROR: Library failed to load from unpkg.<br>Please try checking your internet or firewall.";
            return;
        }

        const $ = (s) => document.querySelector(s);
        const fileInput = $('#file');
        const convertBtn = $('#convertBtn');
        const statusEl = $('#status');
        const prog = $('#prog');
        const formatEl = $('#format');
        const qualityEl = $('#quality');
        const jpgSettings = $('#jpgSettings');
        const dropzone = $('#dropzone');
        const meta = $('#meta');
        const clearBtn = $('#clearBtn');
        
        let files = [];

        formatEl.addEventListener('change', () => {
             jpgSettings.style.display = formatEl.value === 'jpg' ? '' : 'none';
        });

        function updateMeta() {
             meta.textContent = files.length ? `${files.length} selected` : 'No file';
             clearBtn.disabled = !files.length;
             convertBtn.disabled = !files.length;
             statusEl.textContent = files.length ? "Ready." : "Idle...";
        }

        fileInput.addEventListener('change', (e) => {
            files = Array.from(e.target.files || []);
            updateMeta();
        });

        dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dropping'); });
        dropzone.addEventListener('dragleave', (e) => { e.preventDefault(); dropzone.classList.remove('dropping'); });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dropping');
            files = Array.from(e.dataTransfer?.files || []);
            updateMeta();
        });

        clearBtn.addEventListener('click', () => { files = []; updateMeta(); prog.value=0; });

        convertBtn.addEventListener('click', async () => {
            if (!files.length) return;
            
            convertBtn.disabled = true;
            statusEl.textContent = "Processing...";
            
            const quality = parseFloat(qualityEl.value);
            const format = formatEl.value;
            const mime = format === 'png' ? 'image/png' : 'image/jpeg';

            let i = 0;
            for (const f of files) {
                try {
                    if (!/\.hei[cf]$/i.test(f.name)) {
                        i++; continue; 
                    }

                    statusEl.textContent = `Converting ${f.name}...`;
                    
                    const result = await heic2any({
                        blob: f,
                        toType: mime,
                        quality: quality
                    });

                    const finalBlob = Array.isArray(result) ? result[0] : result;
                    
                    const url = URL.createObjectURL(finalBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = f.name.replace(/\.[^/.]+$/, "") + "." + format;
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
                    
                    i++;
                    prog.value = (i / files.length) * 100;
                    await new Promise(r => setTimeout(r, 50));

                } catch (err) {
                    const errBox = document.getElementById('debug-error');
                    errBox.style.display = 'block';
                    errBox.innerHTML += `❌ Failed: ${f.name} - ${err.message}<br>`;
                    console.error(err);
                }
            }
            
            statusEl.textContent = "All Done!";
            convertBtn.disabled = false;
        });

    })();
  </script>

</main>
</body>
</html>
